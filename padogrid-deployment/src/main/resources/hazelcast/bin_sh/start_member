#!/usr/bin/env bash

# ========================================================================
# Copyright (c) 2020 Netcrest Technologies, LLC. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ========================================================================
  
SCRIPT_DIR="$(cd -P -- "$(dirname -- "$0")" && pwd -P)"
. $SCRIPT_DIR/.addonenv.sh

EXECUTABLE="`basename $0`"

__options()
{
   echo "-cluster -num -simulate -create-script -?"
}

if [ "$OPTIONS" == "true" ]; then
   __options
   exit
fi

if [ "$HELP" == "true" ]; then
cat <<EOF

WORKSPACE
   $PADOGRID_WORKSPACE

NAME
   $EXECUTABLE - Display member configuration information in the specified PadoGrid cluster

SYNOPSIS
   $EXECUTABLE [-cluster cluster_name] [-num member_number] [-simulate] [-create-script] [-?]

DESCRIPTION
   Displays Hazelcast member configuration information. The displayed
   information can be transferred to setup to another environment where
   PadoGrid is not available.

OPTIONS
   -cluster cluster_name
             Cluster name.

   -num member_number
             Member number 1-99.

   -simulate
             If specified then it only displays the member information
             and does not run the member.

   -create-script
             Generates a script file that can be sourced in to run with the 'start.sh' executable
             included in the Hazelcast distribution. If specified, it does not run the member. The
             script file is generated in the cluster directory.

EOF
if [ "$MAN_SPECIFIED" == "false" ]; then
cat <<EOF
DEFAULT
   $EXECUTABLE -cluster $CLUSTER -num $MEMBER_NUM

FILES
   $CLUSTER_DIR/generated
             The directory in which the script is generated.

EOF
fi
cat <<EOF
SEE ALSO
EOF
   printSeeAlsoList "*member*" $EXECUTABLE
   exit
fi

#
# Run the target cluster command if the product is different.
#
if [ "$PRODUCT_CLUSTER_SPECIFIED" == "false" ]; then
   if [ "$THIS_PRODUCT" != "$PRODUCT" ]; then
      $PADOGRID_HOME/$PRODUCT/bin_sh/$EXECUTABLE -product-cluster $CLUSTER "$@"
      exit
   fi
fi

# Get workspace name
WORKSPACE=${PADOGRID_WORKSPACE##*/}
POD=`getClusterProperty "pod.name" "local"`

# Script creation support is for imdg only at this time
if [ "$CREATE_SCRIPT" == "true" ] && [ "$CLUSTER_TYPE" != "imdg" ]; then
   echo >&2 "----------------------------------------------------------------"
   echo >&2 "   WORKSPACE: $PADOGRID_WORKSPACE"
   echo >&2 "CLUSTER_TYPE: $CLUSTER_TYPE"
   echo >&2 "       ERROR: Script creation is currently supported for imdg only. Command aborted."
   echo >&2 "----------------------------------------------------------------"
   exit 1
fi

# Source in Hazelcast specific env
if [ -f $PADOGRID_WORKSPACES_HOME/.hazelcastenv.sh ]; then
   . $PADOGRID_WORKSPACES_HOME/.hazelcastenv.sh
fi

# Set -simulate if specified
if [ "$SIMULATE" == "true" ]; then
   SIMULATE_OPT="-simulate"
else
   SIMULATE_OPT=""
fi
# Set -create_script if specified
if [ "$CREATE_SCRIPT" == "true" ]; then
   CREATE_SCRIPT_OPT="-create-script"
else
   CREATE_SCRIPT_OPT=""
fi

#
# VM cluster
#
VM_ENABLED=`getClusterProperty "vm.enabled" "false"`
if [ "$REMOTE_SPECIFIED" == "false" ]; then
   if [ "$VM_ENABLED" == "true" ]; then
      VM_HOSTS=`getClusterProperty "vm.hosts"`
      if [ "$VM_HOSTS" == "" ]; then
         echo >&2 "----------------------------------------------------------------"
         echo >&2 "WORKSPACE: $PADOGRID_WORKSPACE"
         echo >&2 "    ERROR: VM hosts undefined. Set 'vm.hosts' in the following cluster.properties file."  
         echo >&2 "           $ETC_DIR/cluster.properties"
         echo >&2 "           Command aborted."
         echo >&2 "----------------------------------------------------------------"
         exit 1
      fi
      # Replace , with space
      __VM_HOSTS=$(echo "$VM_HOSTS" | sed "s/,/ /g")
      DEFAULT_USER=$(whoami)
      VM_USER=`getClusterProperty "vm.user" "$DEFAULT_USER"`
      VM_KEY=`getClusterProperty "vm.privateKeyFile"`
      if [ "$VM_KEY" != "" ]; then 
         VM_KEY="-i $VM_KEY"
      elif [ "$VM_PRIVATE_KEY_FILE" != "" ]; then
         VM_KEY="-i $VM_PRIVATE_KEY_FILE"
      fi

      # Determine the host
      __MEMBER_NUMBER=0
      __FOUND="false"
      
      for VM_HOST in $__VM_HOSTS; do
         let __MEMBER_NUMBER=__MEMBER_NUMBER+1
         if [ $__MEMBER_NUMBER -eq $MEMBER_NUM_NO_LEADING_ZERO ]; then
            __FOUND="true"
            if [ "$POD" == "local" ]; then
               NUM=1
            else
               let NUM=__MEMBER_NUMBER
            fi
            ssh -q -n $VM_KEY $VM_USER@$VM_HOST -o stricthostkeychecking=no "$COMMAND_PREFIX $VM_PADOGRID_HOME/$PRODUCT/bin_sh/start_member $SIMULATE_OPT $CREATE_SCRIPT_OPT -cluster $CLUSTER -remote $VM_HOST -workspace $VM_PADOGRID_WORKSPACE -num $NUM"
            break;
         fi
      done
      FIRST_NUMBER=1
      LAST_NUMBER=$__MEMBER_NUMBER
      if [ "$__FOUND" == "false" ]; then
         echo >&2 "ERROR: Invalid member number. Valid range is [$FIRST_NUMBER, $LAST_NUMBER]. Command aborted." 
      fi
      exit
   fi
fi

#
# Local cluster
#

NODE_NAME_PREFIX=`getPodProperty "node.name.prefix" $NODE_NAME_PREFIX`
MEMBER_NUMBER=$MEMBER_NUM_NO_LEADING_ZERO
if [ "$VM_ENABLED" == "true" ]; then
   MEMBER=`getVmMemberName`
else
   MEMBER=`getMemberName $MEMBER_NUMBER`
fi
MEMBER_DIR="$RUN_DIR/$MEMBER"

if  [ ! -d "$CLUSTER_DIR" ]; then
   echo "----------------------------------------------------------------"
   echo "WORKSPACE: $PADOGRID_WORKSPACE"
   echo "  Cluster: $CLUSTER"
   echo "   Status: This cluster has not been created. Please run the create_cluster command to"
   echo "           to create the cluster before running this command."
   echo "----------------------------------------------------------------"
   exit 1
fi

if [ ! -d "$MEMBER_DIR" ]; then
   if [ "$REMOTE_SPECIFIED" == "true" ]; then
      $SCRIPT_DIR/add_member -remote $REMOTE -cluster $CLUSTER -workspace $PADOGRID_WORKSPACE
   else
      echo "----------------------------------------------------------------"
      echo "WORKSPACE: $PADOGRID_WORKSPACE"
      echo "  Cluster: $CLUSTER"
      echo "   Member: $MEMBER"
      echo "   Status: This member has not been configured. Please run the add_member command to configure"
      echo "           new members."
      echo "----------------------------------------------------------------"
      exit 1
   fi
fi

# If the member is already running, then exit.
if [ "$SIMULATE" == "false" ] && [ "$CREATE_SCRIPT" == "false" ]; then
   PID=`getMemberPid $MEMBER $WORKSPACE`
   if [ -n "${PID}" ]; then
      echo "----------------------------------------------------------------"
      echo "WORKSPACE: $PADOGRID_WORKSPACE"
      echo "  Cluster: $CLUSTER"
      echo "   Member: $MEMBER"
      echo "   Status: This member is already running [Member: $MEMBER, PID=$PID]. Command aborted."
      echo "----------------------------------------------------------------"
      exit 1
   fi
fi

# Member port number
MEMBER_PROPERTIES=""
MEMBER_START_PORT=`getClusterProperty "tcp.startPort" $DEFAULT_MEMBER_START_PORT`
MC_HOST=`getClusterProperty "mc.host" $DEFAULT_MC_HOST`
MC_HTTP_PORT=`getClusterProperty "mc.http.port" $DEFAULT_MC_HTTP_PORT`
MC_HTTPS_PORT=`getClusterProperty "mc.https.port" $DEFAULT_MC_HTTPS_PORT`
MC_HTTPS_ENABLED=`getClusterProperty "mc.https.enabled" "false"`
if [ "$MC_HTTPS_ENABLED" == "false" ]; then
   MC_URL="http://${MC_HOST}:${MC_HTTP_PORT}/hazelcast-mancenter"
else
   MC_URL="https://${MC_HOST}:${MC_HTTPS_PORT}/hazelcast-mancenter"
fi
let MEMBER_PORT=MEMBER_START_PORT+MEMBER_NUMBER-1
let MEMBER_END_PORT=MEMBER_START_PORT+MAX_MEMBER_COUNT-1
MEMBER_TCP_LIST=""
VM_ENABLED=`getClusterProperty "vm.enabled" "false"`
if [ "$VM_ENABLED" == "true" ]; then
   VM_HOSTS=`getClusterProperty "vm.hosts"`
   if [ "$VM_HOSTS" == "" ]; then
      echo >&2 "----------------------------------------------------------------"
      echo >&2 "WORKSPACE: $PADOGRID_WORKSPACE"
      echo >&2 "    ERROR: VM hosts undefined. Set 'vm.hosts' in the following cluster.properties file."  
      echo >&2 "           $ETC_DIR/cluster.properties"
      echo >&2 "           Command aborted."
      echo >&2 "----------------------------------------------------------------"
      exit 1
   fi
   # Replace , with space
   __VM_HOSTS=$(echo "$VM_HOSTS" | sed "s/,/ /g")
   for VM_HOST in $__VM_HOSTS; do
      if [ "$MEMBER_TCP_LIST" == "" ]; then
         MEMBER_TCP_LIST="$VM_HOST:$MEMBER_START_PORT"
      else
         MEMBER_TCP_LIST="$MEMBER_TCP_LIST,$VM_HOST:$MEMBER_START_PORT"
      fi
   done
elif [ "$POD" == "local" ]; then
   HOST_NAME=`hostname`
   HOST_NAME=`getClusterProperty "bind.address" "$HOST_NAME"`
   for i in $(seq $MEMBER_START_PORT $MEMBER_END_PORT); do
      if [ "$MEMBER_TCP_LIST" == "" ]; then
         MEMBER_TCP_LIST="$HOST_NAME:$i"
      else
         MEMBER_TCP_LIST="$MEMBER_TCP_LIST,$HOST_NAME:$i"
      fi
   done
else
   MEMBER_PREFIX=`getMemberPrefix`
   MEMBER_COUNT=`getMemberCount`
   NODE_COUNT=`getPodProperty "node.count" "$MEMBER_COUNT"`
   for i in $(seq 1 $MEMBER_COUNT); do
      __MEMBER_NUM=`getMemberNumWithLeadingZero $i`
      NODE_LOCAL="${NODE_NAME_PREFIX}-${__MEMBER_NUM}.local"
      NODE_ADDR="$NODE_LOCAL:$MEMBER_START_PORT"
      if [ "$MEMBER_TCP_LIST" == "" ]; then
         MEMBER_TCP_LIST="$NODE_ADDR"
      else
         MEMBER_TCP_LIST="$MEMBER_TCP_LIST,$NODE_ADDR"
      fi
      # One member per Vagrant VM -> same port number
      MEMBER_PORT=$MEMBER_START_PORT
   done
fi
MEMBER_PROPERTIES="-Dhazelcast-addon.cluster-name=$CLUSTER \
-Dhazelcast-addon.group=$CLUSTER \
-Dhazelcast-addon.tcp.port=$MEMBER_PORT \
-Dhazelcast-addon.tcp.members=$MEMBER_TCP_LIST \
-Dhazelcast-addon.management-center=$MC_URL"

# Debug parameters.
DEBUG_ENABLED=`getClusterProperty "debug.enabled" $DEFAULT_DEBUG_ENABLED`
DEBUG=""
if [ "$DEBUG_ENABLED" == "true" ]; then
   DEBUG_START_PORT=`getClusterProperty "debug.startPort" $DEFAULT_DEBUG_START_PORT`
   if [ "$POD" == "local" ]; then
      let DEBUG_PORT=DEBUG_START_PORT+MEMBER_NUMBER-1
   else
      DEBUG_PORT=$DEBUG_START_PORT
   fi
   DEBUG="-Xdebug -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=$DEBUG_PORT"
else
   DEBUG_PORT="Disabled"
   DEBUG=""
fi

# JMX parameters
JMX_ENABLED=`getClusterProperty "jmx.enabled" $DEFAULT_JMX_ENABLED`
JMX_PARAMETERS=""
if [ "$JMX_ENABLED" == "true" ]; then
   JMX_START_PORT=`getClusterProperty "jmx.startPort" $DEFAULT_JMX_START_PORT`
   if [ "$POD" == "local" ]; then
      let JMX_PORT=JMX_START_PORT+MEMBER_NUMBER-1
   else
      JMX_PORT=$JMX_START_PORT
   fi
   JMX_PARAMETERS="-Dcom.sun.management.jmxremote.port=${JMX_PORT} -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -Dhazelcast.jmx=true"
else
   JMX_PORT="Disabled"
   JMX_PARAMETERS=""
fi

# Set LOG_FILE in the log directory.
if [[ ${OS_NAME} == CYGWIN* ]]; then
   __LOG_DIR="$(cygpath -wp "$LOG_DIR")"
else
   __LOG_DIR=$LOG_DIR
fi
export LOG_FILE_NAME=${MEMBER}.log
export LOG_FILE=$LOG_DIR/${LOG_FILE_NAME}
if [[ ${OS_NAME} == CYGWIN* ]]; then
   export LOG_FILE="$(cygpath -wp "$LOG_FILE")"
   CONFIG_FILE="$(cygpath -wp "$CONFIG_FILE")"
   CLIENT_CONFIG_FILE="$(cygpath -wp "$CLIENT_CONFIG_FILE")"
   JET_CONFIG_FILE="$(cygpath -wp "$JET_CONFIG_FILE")"
fi

# Set heap to the "heap.min/heap.max" values found in the $ETC_DIR/cluster.properties file.
MIN_HEAP_SIZE=`getClusterProperty "heap.min" $DEFAULT_MIN_HEAP_SIZE`
MAX_HEAP_SIZE=`getClusterProperty "heap.max" $DEFAULT_MAX_HEAP_SIZE`

# Set JAVA_OPTS.
JAVA_OPTS="$JAVA_OPTS $MEMBER_PROPERTIES $LOG_PROPERTIES $SHUTDOWN_HOOK_PROPERTIES $JMX_PARAMETERS"
JAVA_OPTS="$JAVA_OPTS -Xms${MIN_HEAP_SIZE} -Xmx${MAX_HEAP_SIZE}"
JAVA_OPTS="-Dpado.vm.id=$MEMBER -Dhazelcast.instance.name=$MEMBER -Dpadogrid.workspace=$WORKSPACE -Dhazelcast.config=$CONFIG_FILE $JAVA_OPTS"
if [ "$CLUSTER_TYPE" == "jet" ]; then
   JAVA_OPTS="$JAVA_OPTS -Djet.home=$JET_HOME"
#   JAVA_OPTS="$JAVA_OPTS -Djet.home=$MEMBER_DIR"
   JAVA_OPTS="$JAVA_OPTS -Dhazelcast.client.config=$CLIENT_CONFIG_FILE -Dhazelcast.jet.config=$JET_CONFIG_FILE"
   if [ "$JET_LICENSE_KEY" != "" ]; then
      JAVA_OPTS="$JAVA_OPTS -Dhazelcast.enterprise.license.key=$JET_LICENSE_KEY"
   fi
else
   if [ "$IMDG_LICENSE_KEY" != "" ]; then
      JAVA_OPTS="$JAVA_OPTS -Dhazelcast.enterprise.license.key=$IMDG_LICENSE_KEY"
   fi
fi
JAVA_OPTS="$JAVA_OPTS ${DEBUG}"

# Set Health Monitor logging
HEALTH_MONITOR_ENABLED=`getClusterProperty "health.log.enabled" $DEFAULT_HEALTH_MONITOR_ENABLED`
if [ "$HEALTH_MONITOR_ENABLED" == "true" ]; then
   JAVA_OPTS="$JAVA_OPTS $HEALTH_MONITOR_PROPERTIES"
fi

# Set Diagnostic loggging
DIAGNOSTICS_ENABLED=`getClusterProperty "diagnostics.log.enabled" $DEFAULT_DIAGNOSTICS_ENABLED`
if [ "$DIAGNOSTICS_ENABLED" == "true" ]; then
   JAVA_OPTS="$JAVA_OPTS -Dhazelcast.diagnostics.enabled=true $DIAGNOSTICS_PROPERTIES"
   JAVA_OPTS="$JAVA_OPTS -Dhazelcast.diagnostics.filename.prefix=$MEMBER"
   JAVA_OPTS="$JAVA_OPTS -Dhazelcast.diagnostics.directory=${__LOG_DIR}"
fi

# Set PROMETHEUS paths
PROMETHEUS_ENABLED=`getClusterProperty "prometheus.enabled" $DEFAULT_PROMETHEUS_ENABLED`
if [ "$PROMETHEUS_ENABLED" == "true" ]; then
   PROMETHEUS_START_PORT=`getClusterProperty "prometheus.startPort" $DEFAULT_PROMETHEUS_START_PORT`
   if [ "$POD" == "local" ]; then
      let PROMETHEUS_PORT=PROMETHEUS_START_PORT+MEMBER_NUMBER-1
   else
      PROMETHEUS_PORT=$PROMETHEUS_START_PORT
   fi
   PROMETHEUS_CONFIG_FILE_PATH="$ETC_DIR/prometheus.yml"
   PROMETHEUS_JAR_PATH=`find $PADOGRID_HOME/lib -name jmx_prometheus_javaagent*.jar`

   if [[ ${OS_NAME} == CYGWIN* ]]; then
      PROMETHEUS_JAR_PATH="$(cygpath -wp "$PROMETHEUS_JAR_PATH")"
      PROMETHEUS_CONFIG_FILE_PATH="$(cygpath -wp "$PROMETHEUS_CONFIG_FILE_PATH")"
      # Remove the disk drive letter from the path. A workaround to a bug in the prometheus exporter.
      PROMETHEUS_CONFIG_FILE_PATH=${PROMETHEUS_CONFIG_FILE_PATH:2}
   fi
   JAVA_OPTS="$JAVA_OPTS -javaagent:$PROMETHEUS_JAR_PATH=$PROMETHEUS_PORT:$PROMETHEUS_CONFIG_FILE_PATH"
else
   PROMETHEUS_PORT="Disabled"
fi

# Set GC log
GC_LOG_ENABLED=`getClusterProperty "gc.log.enabled" $DEFAULT_GC_LOG_ENABLED`
GC_LOG_FILE_ENABLED=`getClusterProperty "gc.log.file.enabled" $DEFAULT_GC_LOG_FILE_ENABLED`
if [ $GC_LOG_ENABLED == "true" ]; then
   if [ $GC_LOG_FILE_ENABLED == "true" ]; then
      GC_LOG_FILE=$LOG_DIR/${MEMBER}-gc.log
      if [[ ${OS_NAME} == CYGWIN* ]]; then
         GC_LOG_FILE="$(cygpath -wp "$GC_LOG_FILE")"
      fi
      if [[ $JAVA_VERSION == 1.8* ]]; then
         JAVA_OPTS="$JAVA_OPTS -Xloggc:$GC_LOG_FILE -XX:+PrintGCDetails -XX:+PrintGCDateStamps"
      else
         JAVA_OPTS="$JAVA_OPTS -Xlog:gc=info:file=$GC_LOG_FILE:time,uptime,pid:filecount=5,filesize=4096"
      fi
   fi
fi

if [[ $JAVA_VERSION != 1.8* ]]; then
   # Extracted from Hazelcast start.sh:
   JAVA_OPTS="$JAVA_OPTS --add-modules java.se --add-exports java.base/jdk.internal.ref=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.nio=ALL-UNNAMED --add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens java.management/sun.management=ALL-UNNAMED --add-opens jdk.management/com.sun.management.internal=ALL-UNNAMED"
fi

# Start the member
if [[ ${OS_NAME} == CYGWIN* ]]; then
   CLASSPATH="$(cygpath -wp "$CLASSPATH")"
fi
export LOG_DIR=$__LOG_DIR

# Export JAVA_OPTS and CLASSPATH so that RUN_SCRIPT can hijack the executable.
export JAVA_OPTS
export CLASSPATH
export JAVA

POD=`getClusterProperty "pod.name" $POD`
if [ "$POD" != "local" ] && [ "$REMOTE_SPECIFIED" == "false" ]; then
   NODE_NAME_PREFIX=`getPodProperty "node.name.prefix" $NODE_NAME_PREFIX`
   NODE_LOCAL="${NODE_NAME_PREFIX}-${MEMBER_NUM}.local"
   ssh -q -n $SSH_USER@$NODE_LOCAL -o stricthostkeychecking=no "$COMMAND_PREFIX $REMOTE_BASE_DIR/$PRODUCT/bin_sh/$EXECUTABLE -remote $NODE_LOCAL -workspace $PADOGRID_WORKSPACE $@"
   exit
elif [ "$SIMULATE" == "true" ]; then
   PID="Simulated"
elif [ "$CREATE_SCRIPT" == "true" ]; then
   PID="Script"
else
   # LOG_FILE might not exist if a VM bundle has been deployed.
   if  [ ! -d "$LOG_DIR" ]; then
      mkdir -p $LOG_DIR
   fi
   if [ "$RUN_SCRIPT" != "" ]; then
      nohup $RUN_SCRIPT >> $LOG_FILE &
   else
	   
      pushd ${MEMBER_DIR} > /dev/null 2>&1
      if [ "$CLUSTER_TYPE" == "jet" ]; then
         if [ $HAZELCAST_MAJOR_VERSION_NUMBER -ge 4 ]; then
            nohup "$JAVA" -server $JAVA_OPTS com.hazelcast.jet.server.JetMemberStarter >> $LOG_FILE 2>&1 &
         else
            nohup "$JAVA" -server $JAVA_OPTS com.hazelcast.jet.server.StartServer >> $LOG_FILE 2>&1 &
	 fi
      else
         if [ $HAZELCAST_MAJOR_VERSION_NUMBER -ge 4 ]; then
            nohup "$JAVA" -server $JAVA_OPTS com.hazelcast.core.server.HazelcastMemberStarter >> $LOG_FILE 2>&1 &
         else
            nohup "$JAVA" -server $JAVA_OPTS com.hazelcast.core.server.StartServer >> $LOG_FILE 2>&1 &
	 fi
      fi
      popd > /dev/null 2>&1
   fi
   PID=$!
fi

# JMX_URL
JMX_URL="service:jmx:rmi:///jndi/rmi://$HOSTNAME_FOR_CLIENTS:$JMX_PORT/jmxrmi"

echo "----------------------------------------------------------------"
echo "      WORKSPACE: $PADOGRID_WORKSPACE"
echo "        Cluster: $CLUSTER"
if [ "$VM_SPECIFIED" == "true" ] || [ "$VM_ENABLED" == "true" ]; then
echo "     Deployment: VM"
else
echo "            Pod: $POD"
fi
echo "         Member: $MEMBER"
echo "            PID: $PID"
echo "   CLUSTER_TYPE: $CLUSTER_TYPE"
echo "    WORKING_DIR: $MEMBER_DIR"
echo "     CONFIG_DIR: $ETC_DIR"
echo "    CONFIG_FILE: $CONFIG_FILE"
echo "        LOG_DIR: $LOG_DIR"
echo "       LOG_FILE: $LOG_FILE"
echo "     MEMBER_PORT $MEMBER_PORT"
echo "     DEBUG_PORT: $DEBUG_PORT"
echo "PROMETHEUS_PORT: $PROMETHEUS_PORT"
echo "       JMX_PORT: $JMX_PORT"
echo "         MC_URL: $MC_URL"
if [ "$JMX_ENABLED" == "true" ]; then
echo "        JMX_URL: $JMX_URL"
fi
echo "           JAVA: $JAVA"
if [ "$RUN_SCRIPT" != "" ]; then
echo -e "     RUN_SCRIPT: ${CLightGreen}$RUN_SCRIPT${CNone}"
fi
echo "      JAVA_OPTS: $JAVA_OPTS"
echo "      CLASSPATH: $CLASSPATH"
echo "----------------------------------------------------------------"

if [ "$SIMULATE" == "true" ]; then
   echo ""
   echo "JAVA_OPTS"
   echo "---------"
   printJavaOpts "$JAVA_OPTS"
   echo ""
   echo "CLASSPATH"
   echo "---------"
   printClassPath "$CLASSPATH"
   echo ""
   echo "Environment Variable(s)"
   echo "-----------------------"
   echo "LOG_FILE=$LOG_FILE"
   echo ""
fi
if [ "$CREATE_SCRIPT" == "true" ]; then

#
# Creates the header part in the specified file
#
# @required CLUSTER      Cluster name
# @param filePath        File path
# @param scriptName      Script file name
# @param deploymentType  'VM' or 'local'
#
function writeHeader()
{
   __SCRIPT_FILE=$1
   __SCRIPT_NAME=$2
   __DEPLOYMENT_TYPE=$3
   echo "#!/usr/bin/env bash" > $__SCRIPT_FILE
   echo "SCRIPT_DIR=\"\$(cd -P -- \"\$(dirname -- \"\$0\")\" && pwd -P)\"" >> $__SCRIPT_FILE
   echo "BASE_DIR=\"\$(dirname \"\$SCRIPT_DIR\")\"" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "# ------------------------------------------------------" >> $__SCRIPT_FILE
   echo "# Deployment: $__DEPLOYMENT_TYPE" >> $__SCRIPT_FILE
   echo "#       File: $__SCRIPT_NAME" >> $__SCRIPT_FILE
   echo "#    Cluster: $CLUSTER" >> $__SCRIPT_FILE
   echo "#  Generated: `date "+%m/%d/%y %H:%M:%S %Z"`" >> $__SCRIPT_FILE
   echo "#         By: `whoami`" >> $__SCRIPT_FILE
   echo "# ------------------------------------------------------" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Source in this file to set the environment variables and run 'start.sh'" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Set the Hazelcast installation path." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "HAZELCAST_DIR=\"\$(dirname \"\$BASE_DIR\")\"" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Set enterprise license key." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "LICENSE_KEY=" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "# Determine the Hazelcast version." >> $__SCRIPT_FILE
   if [ "$IS_HAZELCAST_ENTERPRISE" == "true" ]; then
   echo "for file in \$HAZELCAST_DIR/lib/hazelcast-enterprise-all-*; do" >> $__SCRIPT_FILE
   echo "   file=\${file##*hazelcast\\-enterprise\\-all\\-}" >> $__SCRIPT_FILE
   echo "   HAZELCAST_VERSION=\${file%.jar}" >> $__SCRIPT_FILE
   echo "done" >> $__SCRIPT_FILE
   else
   echo "for file in \$HAZELCAST_DIR/lib/hazelcast-all-*; do" >> $__SCRIPT_FILE
   echo "   file=\${file##*hazelcast\\-all\\-}" >> $__SCRIPT_FILE
   echo "   HAZELCAST_VERSION=\${file%.jar}" >> $__SCRIPT_FILE
   echo "done" >> $__SCRIPT_FILE
   fi
}

#
# Appends the VM top body part in the specified file
#
# @required JMX_START_PORT   Base JMX port
# @required DEBUG_START_PORT Base debug port
# @param filePath            File path
# @param memberTcpList       TCP interfaces separated by commas
#
function writeVmTopBody()
{
   __SCRIPT_FILE=$1
   __MEMBER_TCP_LIST=$2
   echo "#" >> $__SCRIPT_FILE
   echo "# Cluster name used in padogrid. This name is used as the prefix" >> $__SCRIPT_FILE
   echo "# to the Hazelcast instance name." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "CLUSTER=$CLUSTER" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Host name of this machine. The host name is used to build the member" >> $__SCRIPT_FILE
   echo "# TCP interface list for the cluster." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "HOST_NAME=\`hostname\`" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Member TCP port number" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "TCP_PORT=5701" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# JMX port" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "JMX_PORT=$JMX_START_PORT" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Debug port" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "DEBUG_PORT=$DEBUG_START_PORT" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Prometheus port" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "PROMETHEUS_PORT=$PROMETHEUS_START_PORT" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Member number. If you need to run more than one member on the same" >> $__SCRIPT_FILE
   echo "# machine then increment the number for the additional members." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "MEMBER_NUMBER=01" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Comma separated member TCP interface list. This list is read by the etc/hazelcast.xml file." >> $__SCRIPT_FILE
   echo "# Example: MEMBER_TCP_LIST=\"host1:5701,host2:5701,host3:5703\"" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "MEMBER_TCP_LIST=$__MEMBER_TCP_LIST" >> $__SCRIPT_FILE
}

#
# Appends the local top body part in the specified file
#
# @required JMX_START_PORT        Base JMX port
# @required DEBUG_START_PORT      Base debug port
# @required PROMETHEUS_START_PORT Base Prometheus port
# @param filePath                 File path
#
function writeLocalTopBody()
{
   __SCRIPT_FILE=$1
   echo "#" >> $__SCRIPT_FILE
   echo "# The first argument is the member number. Default: 1" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "MEMBER_NUMBER=\"\$2\"" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Maximum number of members. This number is used to build the member" >> $__SCRIPT_FILE
   echo "# TCP interface list for the cluster." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "MAX_MEMBER_COUNT=20" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Cluster name used in padogrid. This name is used as the prefix" >> $__SCRIPT_FILE
   echo "# to the Hazelcast instance name." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "CLUSTER=$CLUSTER" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Member start port number. Member port number is determined by adding"  >> $__SCRIPT_FILE
   echo "# the specified member number to the start port number." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "MEMBER_START_PORT=5701" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# JMX start port number." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "JMX_START_PORT=$JMX_START_PORT" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Debug start port number." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "DEBUG_START_PORT=$DEBUG_START_PORT" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Host name of this machine. The host name is used to build the member" >> $__SCRIPT_FILE
   echo "# TCP interface list for the cluster." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "HOST_NAME=\`hostname\`" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Determine member number" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "if [ \"\$MEMBER_NUMBER\" == \"\" ]; then" >> $__SCRIPT_FILE
   echo "   MEMBER_NUMBER=\"1\"" >> $__SCRIPT_FILE
   echo "elif [ \"\$MEMBER_NUMBER\" -le 0 ]; then" >> $__SCRIPT_FILE
   echo "   echo >&2 \"ERROR: Invalid member number. Must be greater than 0. Command aborted.\"" >> $__SCRIPT_FILE
   echo "elif [ \"\$MEMBER_NUMBER\" -gt \"\$MAX_MEMBER_COUNT\" ]; then" >> $__SCRIPT_FILE
   echo "   echo >&2 \"ERROR: Invalid member number. Must be less than or equal to \$MAX_MEMBER_COUNT. Command aborted.\"" >> $__SCRIPT_FILE
   echo "fi" >> $__SCRIPT_FILE
   echo "MEMBER_NUMBER=\$((10#\$MEMBER_NUMBER))" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Member TCP interface list. This list is read by the etc/hazelcast.xml file." >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "let MEMBER_END_PORT=MEMBER_START_PORT+MAX_MEMBER_COUNT-1" >> $__SCRIPT_FILE
   echo "MEMBER_TCP_LIST=\"\"" >> $__SCRIPT_FILE
   echo "for i in \$(seq \$MEMBER_START_PORT \$MEMBER_END_PORT); do" >> $__SCRIPT_FILE
   echo "   if [ \"\$MEMBER_TCP_LIST\" == \"\" ]; then" >> $__SCRIPT_FILE
   echo "      MEMBER_TCP_LIST="\$HOST_NAME:\$i"" >> $__SCRIPT_FILE
   echo "   else" >> $__SCRIPT_FILE
   echo "      MEMBER_TCP_LIST="\$MEMBER_TCP_LIST,\$HOST_NAME:\$i"" >> $__SCRIPT_FILE
   echo "   fi" >> $__SCRIPT_FILE
   echo "done" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Set TCP port for this member" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "let TCP_PORT=MEMBER_START_PORT+MEMBER_NUMBER-1" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# JMX port" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "let JMX_PORT=JMX_START_PORT+MEMBER_NUMBER-1" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Debug port" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "let PROMETHEUS_PORT=PROMETHEUS_START_PORT+MEMBER_NUMBER-1" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Debug port" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "let DEBUG_PORT=DEBUG_START_PORT+MEMBER_NUMBER-1" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Add leading 0 to single digit member number" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "if [ \"\$MEMBER_NUMBER\" -lt 10 ]; then" >> $__SCRIPT_FILE
   echo "   MEMBER_NUMBER=\"0\${MEMBER_NUMBER}\"" >> $__SCRIPT_FILE
   echo "fi" >> $__SCRIPT_FILE
   
}

#
# Appends the bottom body part in the specified file
#
# @required JAVA_OPTS  Java options
# @required CLASSPATH  Class path
# @required OS_NAME    OS name
# @param    filePath   File path
#
function writeBottomBody()
{
   __SCRIPT_FILE=$1
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Hazelcast instance name" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "INSTANCE_NAME=\$CLUSTER-\$HOST_NAME-\$MEMBER_NUMBER" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Distribution Directories" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "ETC_DIR=\$BASE_DIR/etc" >> $__SCRIPT_FILE
   echo "LIB_DIR=\$HAZELCAST_DIR/user-lib" >> $__SCRIPT_FILE
   echo "LOG_DIR=\$BASE_DIR/log" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# Log file path. This environment variable is picked up by log4j2 in" >> $__SCRIPT_FILE
   echo "# the config file etc/log4j2.properties" >> $__SCRIPT_FILE
   echo "export LOG_FILE=\$LOG_DIR/\${INSTANCE_NAME}.log" >> $__SCRIPT_FILE
   echo "" >> $__SCRIPT_FILE
   echo "# Run script. If specified, then start_member.sh runs this script instead of start.sh." >> $__SCRIPT_FILE
   echo "# It must be in the same directory as start_member.sh." >> $__SCRIPT_FILE
   if [ "$RUN_SCRIPT" == "" ]; then
   echo "RUN_SCRIPT=\"\"" >> $__SCRIPT_FILE
   else
   __RUN_SCRIPT_FILE_NAME="`basename $RUN_SCRIPT`"
   echo "RUN_SCRIPT=$__RUN_SCRIPT_FILE_NAME" >> $__SCRIPT_FILE
   fi
   echo "" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "# JAVA_OPTS" >> $__SCRIPT_FILE
   echo "#" >> $__SCRIPT_FILE
   echo "export JAVA_OPTS=\"" >> $__SCRIPT_FILE
   for token in $JAVA_OPTS; do
      if [[ $token == -D* ]]; then
         if [[ $token == -Dhazelcast.instance.name=* ]]; then
            echo "-Dhazelcast.instance.name=\$INSTANCE_NAME \\"  >> $__SCRIPT_FILE
         elif [[ $token == -Dhazelcast-addon.tcp.port=* ]]; then
            echo "-Dhazelcast-addon.tcp.port=\$TCP_PORT \\"  >> $__SCRIPT_FILE
         elif [[ $token == -Dhazelcast-addon.tcp.members=* ]]; then
            echo "-Dhazelcast-addon.tcp.members=\$MEMBER_TCP_LIST \\"  >> $__SCRIPT_FILE
         elif [[ $token == -Dhazelcast.config=* ]]; then
            echo "-Dhazelcast.config=\$ETC_DIR/hazelcast.xml \\"  >> $__SCRIPT_FILE
         elif [[ $token == -Dlog4j.configurationFile=* ]]; then
            echo "-Dlog4j.configurationFile=\$ETC_DIR/log4j2.properties \\" >> $__SCRIPT_FILE
         elif [[ $token == -Dhazelcast.diagnostics.directory=* ]]; then
            echo "-Dhazelcast.diagnostics.directory=\$LOG_DIR \\" >> $__SCRIPT_FILE
         elif [[ $token == -Dhazelcast.enterprise.license.key=* ]]; then
            echo "-Dhazelcast.enterprise.license.key=\$LICENSE_KEY \\"  >> $__SCRIPT_FILE
         elif [[ $token == -Dcom.sun.management.jmxremote.port=* ]]; then
            echo "-Dcom.sun.management.jmxremote.port=\$JMX_PORT \\" >> $__SCRIPT_FILE
         else
            echo "$token \\"  >> $__SCRIPT_FILE
         fi
      fi
   done
   for token in $JAVA_OPTS; do
      if [[ $token != -D* ]]; then
         if [[ $token == *prometheus* ]]; then
            PROMETHEUS_JAR="jmx_prometheus_javaagent${PROMETHEUS_JAR_PATH##*jmx_prometheus_javaagent}"
            echo "-javaagent:\$LIB_DIR/$PROMETHEUS_JAR=\$PROMETHEUS_PORT:\$ETC_DIR/prometheus.yml \\" >> $__SCRIPT_FILE
         elif [[ $token == -Xloggc:* ]]; then
            echo "-Xloggc:\${LOG_DIR}/\${INSTANCE_NAME}-gc.log \\" >> $__SCRIPT_FILE
         elif [[ $token == -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=* ]]; then
            echo "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=\$DEBUG_PORT \\" >> $__SCRIPT_FILE
         else
            echo "$token \\" >> $__SCRIPT_FILE
         fi
      fi
   done

   if [[ ${OS_NAME} == CYGWIN* ]]; then
      DELIMITER=";"
   else
      DELIMITER=":"
   fi
   echo "\""  >> $__SCRIPT_FILE
}

   if [ -d "${CLUSTER_DIR}/generated/tmp" ]; then
      rm -rf ${CLUSTER_DIR}/generated/tmp
   fi
   __BIN_DIR=${CLUSTER_DIR}/generated/tmp/$CLUSTER/bin
   if [ ! -d "${__BIN_DIR}" ]; then
      mkdir -p ${__BIN_DIR}
   fi
   if [ "$VM_ENABLED" == "true" ]; then
      DEFAULT_SCRIPT_NAME="setenv_vm.sh"
      DEPLOYTMENT_TYPE="VM"
   else
      DEFAULT_SCRIPT_NAME="setenv_local.sh"
      DEPLOYTMENT_TYPE="local"
   fi
   # DEFAULT_SCRIPT_NAME is also used later when generating start_member.sh
   SCRIPT_FILE="${__BIN_DIR}/${DEFAULT_SCRIPT_NAME}"
   writeHeader $SCRIPT_FILE $DEFAULT_SCRIPT_NAME $DEPLOYTMENT_TYPE

   if [ "$VM_ENABLED" == "true" ]; then
      # For VM, requires host names
      VM_HOSTS=`getClusterProperty "vm.hosts"`
      MEMBER_TCP_LIST=""
      # Replace , with space
      __VM_HOSTS=$(echo "$VM_HOSTS" | sed "s/,/ /g")
      for VM_HOST in $__VM_HOSTS; do
         if [ "$MEMBER_TCP_LIST" == "" ]; then
            MEMBER_TCP_LIST="$VM_HOST:$MEMBER_START_PORT"
         else
            MEMBER_TCP_LIST="$MEMBER_TCP_LIST,$VM_HOST:$MEMBER_START_PORT"
         fi
      done
      writeVmTopBody $SCRIPT_FILE $MEMBER_TCP_LIST
   else
      # For local, use the local machine's host name
      writeLocalTopBody $SCRIPT_FILE
   fi
   writeBottomBody $SCRIPT_FILE

   #
   # For local cluster, let's also generate an optional VM script
   #
   if [ "$VM_ENABLED" == "true" ]; then
      SCRIPT_NAME="setenv_local.sh"
      SCRIPT_FILE="${__BIN_DIR}/${SCRIPT_NAME}"
      writeHeader $SCRIPT_FILE $SCRIPT_NAME "local"
      writeLocalTopBody $SCRIPT_FILE
      writeBottomBody $SCRIPT_FILE
   else
      SCRIPT_NAME="setenv_vm.sh"
      SCRIPT_FILE="${__BIN_DIR}/${SCRIPT_NAME}"
      writeHeader $SCRIPT_FILE $SCRIPT_NAME "VM"
      writeVmTopBody $SCRIPT_FILE ""
      writeBottomBody $SCRIPT_FILE
   fi

   #
   # Copy lib and config files
   #
   __LIB_DIR=${CLUSTER_DIR}/generated/tmp/user-lib
   __LOG_DIR=${CLUSTER_DIR}/generated/tmp/$CLUSTER/log
   __ETC_DIR=${CLUSTER_DIR}/generated/tmp/$CLUSTER/etc
   mkdir -p $__LIB_DIR
   mkdir -p $__LOG_DIR
   mkdir -p $__ETC_DIR
   __VERSION_DIR=v${HAZELCAST_VERSION:0:1}
   cp $PADOGRID_HOME/lib/* $__LIB_DIR/ > /dev/null 2>&1
   cp $BASE_DIR/lib/* $__LIB_DIR/ > /dev/null 2>&1
   cp -r $BASE_DIR/lib/$__VERSION_DIR/* $__LIB_DIR/ > /dev/null 2>&1
   cp $BASE_DIR/plugins/* $__LIB_DIR/ > /dev/null 2>&1
   cp -r $BASE_DIR/plugins/$__VERSION_DIR/* $__LIB_DIR/ > /dev/null 2>&1
   cp -r $CLUSTER_DIR/lib/* $__LIB_DIR/ > /dev/null 2>&1
   cp -r $CLUSTER_DIR/plugins/* $__LIB_DIR/ > /dev/null 2>&1
   cp -r $PADOGRID_WORKSPACE/lib/* $__LIB_DIR/ > /dev/null 2>&1
   cp -r $PADOGRID_WORKSPACE/plugins/* $__LIB_DIR/ > /dev/null 2>&1
   cp -r $HAZELCAST_HOME/user-lib/* $__LIB_DIR/ > /dev/null 2>&1
   cp -r $CLUSTER_DIR/etc/hazelcast.xml $__ETC_DIR/ > /dev/null 2>&1
   cp -r $CLUSTER_DIR/etc/log4j2.properties $__ETC_DIR/ > /dev/null 2>&1
   cp -r $CLUSTER_DIR/etc/prometheus.yml $__ETC_DIR/ > /dev/null 2>&1

   #
   # README.txt
   #
   README_FILE="${CLUSTER_DIR}/generated/tmp/$CLUSTER/README.txt"
   echo "PadoGrid Script Distribution" > $README_FILE
   echo "****************************" >> $README_FILE
   echo "" >> $README_FILE
   echo "This distribtuion has been generated by PadoGrid. It contains all the" >> $README_FILE
   echo "necessary scripts, binaries, and configuration files to reinstate the same Hazelcast" >> $README_FILE
   echo "cluster that was previously running in the PadoGrid workspace environment." >> $README_FILE
   echo "The scripts provided in this distribution are readily executable in the Hazelcast" >> $README_FILE
   echo "product distribution environment." >> $README_FILE
   echo "" >> $README_FILE
   echo "# ------------------------------------------------------" >> $README_FILE
   if [ "$VM_ENABLED" == "true" ]; then
   echo "# Deployment: VM" >> $README_FILE
   else
   echo "# Deployment: local" >> $README_FILE
   fi
   echo "#       File: README.txt" >> $README_FILE
   echo "#    Cluster: $CLUSTER" >> $README_FILE
   echo "#  Generated: `date "+%m/%d/%y %H:%M:%S %Z"`" >> $README_FILE
   echo "#         By: `whoami`" >> $README_FILE
   echo "# ------------------------------------------------------" >> $README_FILE
   echo "" >> $README_FILE
   echo "Directories" >> $README_FILE
   echo "-----------" >> $README_FILE
   echo "" >> $README_FILE
   echo "." >> $README_FILE
   echo "├── $CLUSTER" >> $README_FILE
   echo "│   ├── README.txt" >> $README_FILE
   echo "│   ├── bin" >> $README_FILE
   echo "│   │   ├── setenv_local.sh" >> $README_FILE
   echo "│   │   ├── setenv_vm.sh" >> $README_FILE
   echo "│   │   └── start_member.sh" >> $README_FILE
   echo "│   ├── etc" >> $README_FILE
   echo "│   │   ├── hazelcast.xml" >> $README_FILE
   echo "│   │   ├── log4j2.properties" >> $README_FILE
   echo "│   │   └── prometheus.yml" >> $README_FILE
   echo "│   └── log" >> $README_FILE
   echo "└── user-lib" >> $README_FILE
   USER_LIB_FILES=$(ls $__LIB_DIR)
   USER_LIB_FILES=( $USER_LIB_FILES )
   let FILE_COUNT=${#USER_LIB_FILES[@]}
   let LAST_INDEX=FILE_COUNT-1
   for ((i = 0; i <= $LAST_INDEX; i++)); do
      if [ $i -lt $LAST_INDEX ]; then
         echo "    ├── ${USER_LIB_FILES[$i]}" >> $README_FILE
      else
         echo "    └── ${USER_LIB_FILES[$i]}" >> $README_FILE
      fi
   done
   echo "" >> $README_FILE
   echo "bin/" >> $README_FILE
   echo "   setenv_local.sh" >> $README_FILE
   echo "             Sets JAVA_OPTS required by 'start.sh' for running all members on" >> $README_FILE
   echo "             the same local machine." >> $README_FILE
   echo "" >> $README_FILE
   echo "   setenv_vm.sh" >> $README_FILE
   echo "             Sets JAVA_OPTS required by 'start.sh' for running members on" >> $README_FILE
   echo "             separate machines." >> $README_FILE
   echo "" >> $README_FILE
   echo "   start_member.sh" >> $README_FILE
   echo "             Runs 'start.sh' with the specified option ('-local' or '-vm')." >> $README_FILE
   echo "             See the usage by running 'start_member.sh -?'." >> $README_FILE
   echo "" >> $README_FILE
   echo "etc/" >> $README_FILE
   echo "   Contains configuration files." >> $README_FILE
   echo "" >> $README_FILE
   echo "log/" >> $README_FILE
   echo "   All log files are written to this directory." >> $README_FILE
   echo "" >> $README_FILE
   echo "user-lib/" >> $README_FILE
   echo "   Contains all the binaries used by the workspace cluster." >> $README_FILE
   echo "" >> $README_FILE
   echo "Deployment Steps" >> $README_FILE
   echo "----------------" >> $README_FILE
   echo "" >> $README_FILE
   echo "IMPORTANT" >> $README_FILE
   echo "   If you are running more than one member on the same machine, then you must" >> $README_FILE
   echo "   install Hazelcast distribution for each member. For example, untar the Hazelcast" >> $README_FILE
   echo "   distribution and rename the directory to the member name." >> $README_FILE
   echo "" >> $README_FILE
   echo "1. Inflate '${CLUSTER}.tar.gz' inside the Hazelcast installation directory." >> $README_FILE
   echo "   CAUTION: The 'user-lib' directory will be overwritten." >> $README_FILE
   echo "" >> $README_FILE
   echo "2. Edit '$CLUSTER/bin/setenv_local.sh' and/or '$CLUSTER/bin/setenv_vm.sh' and set the" >> $README_FILE
   echo "   following variables (and others as necessary):" >> $README_FILE
   echo "      LICENSE_KEY" >> $README_FILE
   echo "      MEMBER_TCP_LIST (for setenv_vm.sh only)" >> $README_FILE
   echo "      RUN_SCRIPT" >> $README_FILE
   echo "      JAVA_OPTS" >> $README_FILE
   echo "" >> $README_FILE
   echo "3. The changes you made in the above steps apply to all members. You can deploy the" >> $README_FILE
   echo "   same changes to run each member." >> $README_FILE
   echo "" >> $README_FILE
   echo "4. Start a member by running '${CLUSTER}/bin/start_member.sh'" >> $README_FILE
   echo "          Display usage: start_member.sh -?" >> $README_FILE
   echo "      Run local members: start_member.sh -local <member-number>" >> $README_FILE
   echo "         Run VM members: start_member.sh -vm" >> $README_FILE
   echo "" >> $README_FILE
   echo "5. Stop a member by running 'bin/stop.sh', which is part of the Hazelcast distribution." >> $README_FILE
   echo "" >> $README_FILE
   echo "6. The log files are written in the $CLUSTER/log directory." >> $README_FILE

   cp $README_FILE ${CLUSTER_DIR}/generated/

   #
   # Copy RUN_SCRIPT the bin directory if defined
   #
   if [ "$RUN_SCRIPT" != "" ]; then
      cp $RUN_SCRIPT $__BIN_DIR
   fi

   #
   # Append executable to the script in the bin directory
   #
   __START_MEMBER_FILE=$__BIN_DIR/start_member.sh
   echo "#!/usr/bin/env bash" > $__START_MEMBER_FILE
   echo "SCRIPT_DIR=\"\$(cd -P -- \"\$(dirname -- \"\$0\")\" && pwd -P)\"" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "# ------------------------------------------------------" >> $__START_MEMBER_FILE
   echo "#       File: start_member.sh" >> $__START_MEMBER_FILE
   echo "#    Cluster: $CLUSTER" >> $__START_MEMBER_FILE
   echo "#  Generated: `date "+%m/%d/%y %H:%M:%S %Z"`" >> $__START_MEMBER_FILE
   echo "#         By: `whoami`" >> $__START_MEMBER_FILE
   echo "# ------------------------------------------------------" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "EXECUTABLE=\"\`basename \$0\`\"" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "if [ \"\$1\" == \"-?\" ]; then" >> $__START_MEMBER_FILE
   echo "cat <<EOF" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "NAME" >> $__START_MEMBER_FILE
   echo "   \$EXECUTABLE - Execute 'start.sh' with the settings source in from the specified env file" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "SYNOPSIS" >> $__START_MEMBER_FILE
   echo "   \$EXECUTABLE -local|-vm [local_member_number]" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "DESCRIPTION" >> $__START_MEMBER_FILE
   echo "   Executes the 'start.sh' command with the settings sourced in from the" >> $__START_MEMBER_FILE
   echo "   specified env file." >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "OPTIONS" >> $__START_MEMBER_FILE
   echo "   -local" >> $__START_MEMBER_FILE
   echo "             Source in setenv_local.sh" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "   -vm" >> $__START_MEMBER_FILE
   echo "             Source in setenv_vm.sh" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "   local_member_number" >> $__START_MEMBER_FILE
   echo "             Member number starting from 1. This value applies to '-local' only." >> $__START_MEMBER_FILE
   echo "             For '-vm', it is ignored. Default: 1" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "EOF" >> $__START_MEMBER_FILE
   echo "   exit" >> $__START_MEMBER_FILE
   echo "fi" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "if [ \"\$1\" == \"\" ]; then" >> $__START_MEMBER_FILE
   echo "   >&2 echo \"Error: '-local' or '-vm' argument required. Command aborted.\"" >> $__START_MEMBER_FILE
   echo "   exit 1" >> $__START_MEMBER_FILE
   echo "elif [ \"\$1\" == \"-local\" ]; then" >> $__START_MEMBER_FILE
   echo "   SETENV_FILE=\"setenv_local.sh\"" >> $__START_MEMBER_FILE
   echo "elif [ \"\$1\" == \"-vm\" ]; then" >> $__START_MEMBER_FILE
   echo "   SETENV_FILE=\"setenv_vm.sh\"" >> $__START_MEMBER_FILE
   echo "else" >> $__START_MEMBER_FILE
   echo "   >&2 echo \"Error: Invalid argument. Valid arguments are '-local' or '-vm'.\"" >> $__START_MEMBER_FILE
   echo "   >&2 echo \"       Command aborted.\"" >> $__START_MEMBER_FILE
   echo "   exit 1" >> $__START_MEMBER_FILE
   echo "fi" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo ". \$SCRIPT_DIR/\$SETENV_FILE" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "#" >> $SCRIPT_FILE >> $__START_MEMBER_FILE
   echo "# Launch Hazelcast Member" >> $__START_MEMBER_FILE
   echo "#" >> $__START_MEMBER_FILE
   echo "if [ \"\$RUN_SCRIPT\" == \"\" ]; then" >> $__START_MEMBER_FILE
   echo "   \$HAZELCAST_DIR/bin/start.sh" >> $__START_MEMBER_FILE
   echo "else" >> $__START_MEMBER_FILE
   echo "" >> $__START_MEMBER_FILE
   echo "   # Run the script in the Hazelcast bin directory so that we can make use" >> $__START_MEMBER_FILE
   echo "   # of stop.sh." >> $__START_MEMBER_FILE
   echo "   PID_FILE=\$HAZELCAST_DIR/bin/hazelcast_instance.pid" >> $__START_MEMBER_FILE
   echo "   PID=\$(cat \"\${PID_FILE}\");" >> $__START_MEMBER_FILE
   echo "   if [ -z \"\${PID}\" ]; then" >> $__START_MEMBER_FILE
   if [ "$IS_HAZELCAST_ENTERPRISE" == "true" ]; then
   echo "      export CLASSPATH=\"\${HAZELCAST_DIR}/lib/hazelcast-enterprise-all-\${HAZELCAST_VERSION}.jar:\${HAZELCAST_DIR}/user-lib:\${HAZELCAST_DIR}/user-lib/*\"" >> $__START_MEMBER_FILE
   else
   echo "      export CLASSPATH=\"\${HAZELCAST_DIR}/lib/hazelcast-all-\${HAZELCAST_VERSION}.jar:\${HAZELCAST_DIR}/user-lib:\${HAZELCAST_DIR}/user-lib/*\"" >> $__START_MEMBER_FILE
   fi
   echo "      echo \"########################################\"" >> $__START_MEMBER_FILE
   echo "      echo \"# RUN_SCRIPT=\$SCRIPT_DIR/\$RUN_SCRIPT\"" >> $__START_MEMBER_FILE
   echo "      echo \"# JAVA_OPTS=\$JAVA_OPTS\"" >> $__START_MEMBER_FILE
   echo "      echo \"# CLASSPATH=\$CLASSPATH\"" >> $__START_MEMBER_FILE
   echo "      echo \"# starting now....\"" >> $__START_MEMBER_FILE
   echo "      echo \"########################################\"" >> $__START_MEMBER_FILE
   echo "      echo \"Process ID for Hazelcast instance is written to location: {\$PID_FILE}\"" >> $__START_MEMBER_FILE
   echo "   else" >> $__START_MEMBER_FILE
   echo "      \"\$SCRIPT_DIR/\$RUN_SCRIPT\"" >> $__START_MEMBER_FILE
   echo "      echo \"\$! > \${PID_FILE}\"" >> $__START_MEMBER_FILE
   echo "   fi" >> $__START_MEMBER_FILE
   echo "fi" >> $__START_MEMBER_FILE
   chmod 755 "$__START_MEMBER_FILE"

   pushd ${CLUSTER_DIR}/generated/tmp > /dev/null 2>&1
   tar -czvf ${CLUSTER_DIR}/generated/$CLUSTER.tar.gz $CLUSTER user-lib
   popd > /dev/null 2>&1

   rm -r ${CLUSTER_DIR}/generated/tmp

   echo ""
   echo "Script tarball generated:"
   echo ""
   echo -e "   ${CLightGreen}${CLUSTER_DIR}/generated/README.txt${CNone}"
   echo -e "   ${CLightGreen}${CLUSTER_DIR}/generated/$CLUSTER.tar.gz${CNone}"
   echo ""
   echo "See 'README.txt' (also included in the tarball) for instructions."
   echo ""
fi
